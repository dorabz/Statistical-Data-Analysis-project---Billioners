---
title: "SAP - projekt - Milijarderi"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'projekt_sap_dokumentacija.pdf'))})
author: "Dora Bezuk, Marcela Matas, Josip Arelic, Domagoj Marinello"
date: "13.11.2022."
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r error=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library("readxl")
library(tidyverse)
library(dplyr)
library(fastDummies)

```

# Uvod

Pitanja:

1. Ima li neki kontinent statistički značajno više miljarda?

2. Jesu li milijarderi koji su nasljedili bogastvo statistički značajno bogatiji od onih koji nisu?

3. Možete li iz danih varijabli predvidjeti njihovo bogatstvo?

4. Kada biste birali karijeru isključivo prema kriteriju da se obogatite, koju biste industriju izabrali?


# Deskriptivna analiza

Potrebno je učitati podatke.
```{r include=FALSE}
# Učitavanje podataka iz excel datoteke
# Promijeniti path u put do datoteke s podacima
bill_data <- read_excel("billionaires.xlsx")
```

```{r include=FALSE}
dim(bill_data) # dimenzije: 2614 redaka i 22 stupaca
names(bill_data) # imena stupaca
view(bill_data)

# klase pojedinih stupaca
sapply(bill_data, class)

# klasa tablice
class(bill_data) 
# zaključak: bill_data podaci su dobro učitani
```

```{r}
# Pomoćna funkcija za izbacivanje stršećih vrijednosti
remove_outliers <- function(data, data_column) {
  quartiles <- quantile(data_column, probs=c(.25, .75), na.rm = FALSE)
  IQR <- IQR(data_column)
  Lower <- quartiles[1] - 1.5*IQR
  Upper <- quartiles[2] + 1.5*IQR 
  
  return(subset(data, data_column >= Lower & data_column <= Upper))
}

cat('\n Dimenzija podataka: ', dim(bill_data))
```



```{r}
for (col_name in names(bill_data)){
  if (sum(is.na(bill_data[,col_name])) > 0){
    cat('Ukupno nedostajućih vrijednosti za varijablu'
        ,col_name, ': ', sum(is.na(bill_data[,col_name])),'\n')
  }
}

```


```{r}
summary(bill_data)


```
```{r}
sapply(bill_data, class)
```
Naš dataset sastoji se od character i numeric varijabli.

Prvo promotrimo numeričke varijable.
```{r}

hist(bill_data$`wealth.worth in billions` ,main='wealth worth in billions', xlab='wealth', ylab='Frequency', col="pink")

boxplot(bill_data$`wealth.worth in billions`)
summary(bill_data$`wealth.worth in billions`)

```
```{r}

barplot(table(bill_data$wealth.type),las=2,cex.names=.9,main='Wealth type',col="pink")
barplot(table(bill_data$wealth.how.industry),las=2,cex.names=.7,main='Industry',col="pink")
print('Podjela po spolu: ')
table(bill_data$demographics.gender)

```

# Pitanja

## 1. Ima li neki kontinent statistički značajno više miljardi?

Za početak želimo vidjeti je li svim milijarderima u našem datasetu dodijeljen kontinent. S obzirom da kontinent kao varijabla ne postoji, koristit ćemo regiju (location.region). Sada želimo izlistati sve regije koje postoje u datasetu.
```{r}
levels(factor(bill_data$location.region))
```



Ima li nedostajućih vrijednosti? 
```{r}
# is.na ce nam vratiti logical vektor koji ima TRUE na mjestima gdje ima NA:
sum(is.na(bill_data$location.region)) 
 

```

Nema nedostajućih vrijednosti
```{r}
table(bill_data$location.region)



```
S obzirom da imamo regiju Middle East/North Africa trebamo ih rastaviti na kontinente kojima pripadaju (Azija i Afrika). Prvo želimo vidjeti koje sve države postoje u toj regiji u našem datasetu pomoću državljanstva.
```{r}


bill_data$location.citizenship[bill_data$location.region == "Middle East/North Africa"]

```

Sada možemo združiti podatke ovisno o kontinentu.

Kopirajmo najprije podatke u novi data.frame (bill_data_copy).
```{r}
bill_data_copy = data.frame(bill_data)
tracemem(bill_data)==tracemem(bill_data_copy)
untracemem(bill_data_copy)
untracemem(bill_data_copy)
```



```{r,results='hide'}
# Združimo Europu
for (column_name in c("Europe")){
  bill_data_copy$location.region[bill_data_copy$location.region == column_name] = "Europe";
}

# Združimo Afriku
for (column_name in c("Lebanon","Egypt","Morocco","Algeria")){
  bill_data_copy$location.region[bill_data_copy$location.citizenship == column_name] = "Africa";
}

for (column_name in c("Sub-Saharan Africa")){
  bill_data_copy$location.region[bill_data_copy$location.region == column_name] = "Africa";
}

# združimo Sjevernu Ameriku
for (column_name in c("North America")){
  bill_data_copy$location.region[bill_data_copy$location.region == column_name] = "North America";
}

# Združimo Južnu Ameriku
for (column_name in c("Latin America")){
  bill_data_copy$location.region[bill_data_copy$location.region == column_name] = "South America";
}

# Združimo Aziju
for (column_name in c("East Asia","South Asia")){
  bill_data_copy$location.region[bill_data_copy$location.region == column_name] = "Asia";
}
for (column_name in c("Saudi Arabia","Kuwait","United Arab Emirates","Israel","Turkey","Oman","Bahrain")){
  bill_data_copy$location.region[bill_data_copy$location.citizenship == column_name] = "Asia";
}

#Združimo Australiju
for (column_name in c("Australia")){
  bill_data_copy$location.region[bill_data_copy$location.citizenship == column_name] = "Australia";
}


bill_data_copy

```
```{r}
tbl = table(bill_data_copy$location.region)
print(tbl)

```




```{r, echo=FALSE}
df <- data.frame(continent=c("Europe", "Asia", "Africa","North America","South America", "Australia"),
                continent_frequency=c(697, 699, 43, 959, 182, 33))
head(df)
```
library(ggplot2)
```{r}

# Barplot
#p<-ggplot(data=df, aes(x=continent, y=continent_frequency), col="pink") +
#  geom_bar(stat="identity")
#p


box_edu <- ggplot(bill_data_copy %>% filter(!location.region=="0"), aes(x=location.region, y= wealth.worth.in.billions, fill=location.region)) +
    geom_boxplot(alpha=0.7, ) + scale_y_log10() +
    theme(legend.position="none") + labs(x="Continent",y="Wealth")+
    scale_fill_brewer(name="Continent",palette="GnBu")
box_edu

```




```
Sada kad smo završili s pripremom podataka za ovaj zadatak, možemo započeti sa statističkim testovima.
Pretpostavke ANOVA-e su:

- nezavisnost pojedinih podataka u uzorcima,
- normalna razdioba podataka,
- homogenost varijanci među populacijama. 

Nezavisnost uzoraka je zadovoljena s obzirom da jedna osoba ne potječe s više kontinenata.

Kad su veličine grupa podjednake, ANOVA je relativno robusna metoda na blaga odstupanja od pretpostavke normalnosti i homogenosti varijanci. Ipak, dobro je provjeriti koliko su ta odstupanja velika. 

Provjeru normalnosti za svaku pojedinu grupu napravit ćemo Lillieforsovom inačicom KS testa. U ovom slučaju razmatrat ćemo location.region kao varijablu koja određuje grupe (populacije) i wealth kao zavisnu varijablu.

Pretpostavke Lillieforsevog testa:
H0... podaci se ravnaju po normalnoj distribuciji
H1... podaci se ne ravnaju po normalnoj distribuciji

```{r, fig.height = 4, fig.width = 5}

# TODO: zakomentiraj ovu liniju ako ne želimo logaritmirati cijenu

wealth <- log(bill_data_copy$wealth.worth.in.billions, 2)

require(nortest)
lillie.test(wealth)

lillie.test(wealth[bill_data_copy$location.region=='Africa'])
lillie.test(wealth[bill_data_copy$location.region=='Europe'])
lillie.test(wealth[bill_data_copy$location.region=='South America'])
lillie.test(wealth[bill_data_copy$location.region=='North America'])
lillie.test(wealth[bill_data_copy$location.region=='Asia'])
lillie.test(wealth[bill_data_copy$location.region=='Australia'])


hist(wealth[bill_data_copy$location.region=='Africa'], main = "Histogram of wealth in Africa", xlab="Wealth", col= "pink")
hist(wealth[bill_data_copy$location.region=='Europe'], main = "Histogram of wealth in Europe", xlab="Wealth", col= "pink")
hist(wealth[bill_data_copy$location.region=='South America'], main = "Histogram of wealth in South America", xlab="Wealth", col= "pink")
hist(wealth[bill_data_copy$location.region=='North America'], main = "Histogram of wealth in North America", xlab="Wealth", col= "pink")
hist(wealth[bill_data_copy$location.region=='Asia'], main = "Histogram of wealth in Asia", xlab="Wealth", col= "pink")
hist(wealth[bill_data_copy$location.region=='Australia'], main = "Histogram of wealth in Australia", xlab="Wealth", col= "pink")

```
Po rezultatima testa za normalnost (male p vrijednosti) te dobijenim histogramima vidimo da nam normalnost baš i nije zadovoljena. Nastavit ćemo sa provjerom homogenosti varijanci Bartlettovim testom. Njegove pretpostavke su:
H0... varijance između populacija su jednake
H1... varijance su različite

```{r test homogenosti}

# Testiranje homogenosti varijance uzoraka Bartlettovim testom
bill_data_copy2= bill_data_copy%>% filter(!location.region=="0")
wealth2 <- log(bill_data_copy2$wealth.worth.in.billions, 2)
bartlett.test(wealth2 ~ bill_data_copy2$location.region )


var((wealth[bill_data_copy$location.region=='Africa']))
var((wealth[bill_data_copy$location.region=='Asia']))
var((wealth[bill_data_copy$location.region=='Europe']))
var((wealth[bill_data_copy$location.region=='North America']))
var((wealth[bill_data_copy$location.region=='South America']))
var((wealth[bill_data_copy$location.region=='Australia']))

```
S obzirom da na temelju ovih rezultata odbacujemo nultu hipotezu da su nam varijance jednake, ne možemo koristiti ANOVA test. Prvo ćemo prikazati na boxplot grafu ovisnost varijable bogatstva o kontinentu kako bi grafički mogli interpretirati rezultat, a zatim ćemo da utvrdimo sigurnost rezultata koristiti neparametarski Kruskal - Wallis test kao alternativu jednofaktorskoj ANOVA-i.


 

```{r, width=6}

# Graficki prikaz podataka
boxplot(wealth2 ~ bill_data_copy2$location.region, xlab="Continent", ylab="Wealth", col= "pink")

```
Izračunajmo sada srednje vrijednosti bogatstva za svaki kontinent.


```{r}

mean_all= mean(bill_data_copy2$wealth.worth.in.billions)
mean_all
mean_by_continent <- bill_data_copy2 %>% 
  group_by(location.region) %>% 
  summarize(mean_continent = mean(wealth.worth.in.billions))
mean_by_continent


```
Vidimo po našem grafu i brojkama da ima manje razlike između srednjih vrijednosti varijable wealth podijeljene po kontinentima.Sada idemo vidjeti je li ta razlika statistički značajna. Ovaj test služi za testiranje jednakosti srednjih vrijednosti u jednofaktorskoj analizi varijance.
Pretpostavke Kruskal -Wallis testa :
H0... nema razlike između populacija
H1... ima razlike
```{r}

# Alternativa ANOVI - Kruskal - Wallis test

kruskal.test(bill_data_copy2$wealth.worth.in.billions ~ bill_data_copy2$location.region)


```

Kako je p-vrijednost manja od nivoa značajnosti od 0.05, možemo zaključiti da ima statistički značajne razlike između milijardi dijeljenim po kontinentima.

## 2. Jesu li milijarderi koji su nasljedili bogastvo statistički značajno bogatiji od onih koji nisu?

Potrebno je pripremiti podatke za obradu, razdvojiti podatke iz tablice po polju
how.inherited u dva slučaja: inherited (oni koju su nasljedili bogatstvo) i 
non_inherited (oni koji nisu nasljedili bogatstvo).

```{r}
inherited = bill_data[bill_data$wealth.how.inherited!="not inherited",]
non_inherited = bill_data[bill_data$wealth.how.inherited=="not inherited",]
```

Zatim je potrebno izračunati srednju vrijednost (mean) posebno za svaki slučaj
uzimajući u obzir polje worth.in billions.

```{r}
inherited_mean = mean(inherited$`wealth.worth in billions`)
print(inherited_mean)

non_inherited_mean = mean(non_inherited$`wealth.worth in billions`)
print(non_inherited_mean)

```

Na temelju male razlike u srednjim vrijednostima, ne postoje indikacije da su 
milijarderi koji su nasljedili bogatstvo statistički značajno bogatiji 
od onih koji nisu. No, navedeno je potrebno provjeriti.


Kako bi bolje vizualizirali podatke crtamo histogram i box plot za svaki od
slučaja:

```{r}
hist(inherited$`wealth.worth in billions`, breaks = 20)
boxplot(inherited$`wealth.worth in billions`)

hist(non_inherited$`wealth.worth in billions`, breaks = 20)
boxplot(non_inherited$`wealth.worth in billions`)
```

Iz prikazane vizualizacije uočavamo kako se podaci ne ravnaju po
normalnoj distribuciji.

Što se može bolje vidjeti sa sljedećih prikaza:
```{r}
qqnorm(inherited$`wealth.worth in billions`, pch = 1, frame = FALSE,main='Inherited')
qqline(inherited$`wealth.worth in billions`, col = "blue", lwd = 2)

qqnorm(non_inherited$`wealth.worth in billions`, pch = 1, frame = FALSE,main='Non inherited')
qqline(non_inherited$`wealth.worth in billions`, col = "red", lwd = 2)

```

Ipak, uočeno je potrebno dodatno ispitati koristeći Kolmogorov–Smirnov test 
kojim se utvrđuje ravna li se distribucija po normalnoj razdiobi.

```{r, warning=FALSE}
ks.test(inherited$`wealth.worth in billions`, y="pnorm")
ks.test(non_inherited$`wealth.worth in billions`, y="pnorm")
```

Iz dobivenih p vrijednosti u oba slučaja odbacujemo mogućnost da se distribucije
ravnaju po normalnoj razdiobi. 

Time je potvrđena pretpostavka da se podaci ne ravnaju po normalnoj distribuciji.

Potrebno je koristiti neparametarski test Mann–Whitney U test, koji se koristi 
kada se podaci se ravnaju po istim distribucijama (obje distribucije su nakošene
u desno) i uzorci su nezavisni iz jedne i druge populacije (jedna osoba ne može
nasljediti i nenasljediti bogatstvo).


Hipoteze glase:
$$ \begin{aligned}
H_0&: \mu_1 = \mu_2 \\
H_1&: \mu_1 > \mu_2 \quad \quad 
\end{aligned} $$


```{r}
 
wilcox.test(inherited_mean, non_inherited_mean, alt = "greater")

```

Zbog p-vrijednost jednake 0.5, na temelju značajnosti od 50% ne možemo odbaciti 
$H_0$ hipotezu o jednakosti prosječnih vrijednosti bogatstva u korist $H_1$, 
odnosno možemo reći da milijarderi koji su nasljedili bogatstvo nisu statistički
značajno bogatiji od onih koji nisu.



## 3. Možete li iz danih varijabli predvidjeti njihovo bogatstvo?

Cilj ovog pitanja je provjeritit postoji li statistički značajna veza između više ulaznih varijabli (regresora) i izlazne varijable (reakcije,  `wealth.worth in billions`). Korištenjem modela linearne regresije provjeritit ćemo koji regresori najviše utječu na izlaznu varijabu.

Pretpostavke modela:
* linearnost veze X i Y
* pogreške nezavisne, homogene i normalno distribuirane s $\epsilon \sim N (0, \sigma^2 )$


Za predobrardu podataka radimo sljedeće stvari:
* Izbacujemo nepotrebne regresore:
  * name
  * company.name
  * rank
  * location.gdp, više od pola vrijednosti su 0 (netočan podatak)
  * location.coutnry.code i location.citizenship a koristimo location.region koji je veće granulacije
  * wealth.how.from emerging, wealth.how.was founder, wealth.how.was political su konstantne varijable
  * company.sector jer ima previše različitih vrijednosti, koje kad bi one hot encodali bi dali previše stupaca
  * wealth.type_inherited, već sadržan u `inherited`
* ignoriramo uzorke s netočnim podacima (kriva dob)
* povećavamo granulaciju varijable relationship (slične/iste vrijednosti svodimu na jednu)
* izbacujemo manji broj uzoraka koji sadržne null vrijednosti

Sve kategorijske varijable obrađujemo na način da ih pretvorimo u dummy varijable. Svaka kategorijska varijabla predstavljena je svojom novom vlastitom varijablom koja poprima vrijednost 1 u slučaju da originalna katergorijska varijabla odgovara novoj varijabli, inače je vrijednost 0.

Za filtrirani podatkovni skup sve iznose `wealth.worth in billions` množimo sa 1 + (kupovna moć dolara svedena na godinu 2014).

```{r}
exclude_cols = c("name", "company.name", "rank", "location.gdp", "location.country code", "location.citizenship", "wealth.how.from emerging", "wealth.how.was founder", "wealth.how.was political", "company.sector")

bill_data_clean <- bill_data %>% select(-one_of(exclude_cols)) %>% arrange(year)

bill_data_clean[["company.relationship"]] <- tolower(bill_data_clean[["company.relationship"]] )

bill_data_clean <- bill_data_clean %>% filter(demographics.age > 0)
bill_data_clean <- bill_data_clean %>% filter(!location.region == "0")

# inflation rate $1.00 (1996) -> $1.51 (2014), +50.9%
# inflation rate $1.00 (2001) -> $1.34 (2014), +33.7%
bill_data_clean[bill_data_clean$year == "1996", "wealth.worth in billions"] <- bill_data_clean[bill_data_clean$year == "1996", "wealth.worth in billions"] * 1.509
bill_data_clean[bill_data_clean$year == "2001", "wealth.worth in billions"] <- bill_data_clean[bill_data_clean$year == "2001", "wealth.worth in billions"] * 1.337

# Iskoristili smo godinu da ažuriramo cijene (inflacija), sad ju odbacujemo
bill_data_clean <- bill_data_clean %>% select(., -year)

bill_data_clean$company.relationship <- gsub(".*\b(owner)\b.*", "owner", bill_data_clean$company.relationship)
bill_data_clean$company.relationship <- gsub(".*(ceo|chief executive officeor|chief executive officer|chief executive|exectuitve).*", "ceo", bill_data_clean$company.relationship)
bill_data_clean$company.relationship <- gsub(".*(founder).*", "founder", bill_data_clean$company.relationship)
bill_data_clean$company.relationship <- gsub(".*(chair|chari).*", "chairman", bill_data_clean$company.relationship)
bill_data_clean$company.relationship <- gsub(".*(director).*", "director", bill_data_clean$company.relationship)
bill_data_clean$company.relationship <- gsub(".*(head).*", "head", bill_data_clean$company.relationship)
bill_data_clean$company.relationship <- gsub(".*(president).*", "president", bill_data_clean$company.relationship)

bill_data_clean <- bill_data_clean %>% drop_na()

bill_categorical <- bill_data_clean %>% select(where(is_character))
bill_numeric <- bill_data_clean %>% select(where(is.numeric))
bill_categorical_onehot = dummy_cols(bill_categorical, remove_first_dummy = TRUE, remove_selected_columns = TRUE)
bill_categorical_onehot <- bill_categorical_onehot[, colSums(bill_categorical_onehot) > 5]
bill_data_clean <- bind_cols(bill_numeric, bill_categorical_onehot)
```


Bitna pretpostavka multivarijatne linearne regresije je da ne postoji snažna linearna korelacija regresora modela. U ovom koraku provjeriti ćemo postoje li parovi takvih regresori i otkloniti ih ukoliko postoje. Odbaciti ćemo sve regresore za koji postoji neki drugi regresor čiji je aposlutna vrijednost Pearsonovog koeficijenta korelacije veća od 0.9. 

```{r}
correlation_threshold = 0.9
tmp <- corr_table <- cor(bill_data_clean)
tmp[upper.tri(tmp)] <- 0
diag(tmp) <- 0  # clean diagonal which is always 1
bill_data_clean <- bill_data_clean[, apply(tmp,2,function(x) all(x<= correlation_threshold))]

bill_data_clean <- remove_outliers(bill_data_clean, bill_data_clean$`wealth.worth in billions`)
wealth <- bill_data_clean$`wealth.worth in billions`
```
Prije stvaranja linearnog modela pogledajmo kojih 5 varijabli najviše lienarno koorelira sa `wealth.worth in billions`. Rezultati koje dobijemo ne možemo direktno koristiti za statističko zaključivanje, ali možemo kasnije usporediti linearne koorelacije sa rezultatima i zaključcima koje ćemo dobiti nakon stvaranja linearnog modela.
```{r}
w <- corr_table[, "wealth.worth in billions"]
w <- abs(w)

corr_wealth_vars <- w[order(w, decreasing = TRUE)]
cat("")
corr_wealth_vars[2:6]
```

```{r}
# x setup, y = wealth
normalized<-function(y) {
  x<-y[!is.na(y)]
  x<-(x - min(x)) / (max(x) - min(x))
  y[!is.na(y)]<-x
  return(y)
}

# `wealth.how.industry_Retail, Restaurant` casues fitting issues
exclude_cols = c("wealth.worth in billions", "wealth.how.industry_Retail, Restaurant", "wealth.type_inherited")
x <- bill_data_clean %>% select(-one_of(exclude_cols))
x[, c("company.founded", "demographics.age")] <- apply(x[, c("company.founded", "demographics.age")] , 2 , normalized) # minmax scaling
x <- x[,order(colnames(x))]

```

Prvi linaerni model stovrili smo naivno na načim da smo iskoristili sve moguće regresore. Provjerom vrijednosti `adj.r.squared` saznati ćemo koliki postotak varijance u podacima opisuje stvoreni linaerni model. Također, provjeriti ćemo koji regresori objašnjavaju najveći postotak varijance na način da ih poredamo po p vrijednostima.
```{r}
cat("Ukupan broj regresora:", length(colnames(x)), "\n")
p_value_column <- 4
model_all_vars <- lm(wealth ~ . , x)
sa <- summary(model_all_vars)
cat("Postotak varijance objašnjen linearnim modelom", sa$adj.r.squared * 100, "%\n")
coef <- sa$coefficients
coef_sorted <- coef[order(coef[,p_value_column]),]
cat("Prvih 5 regresora sortiranih uzlazno po p vrijednosti:\n")
coef_sorted[1:5,]
```

U ovom slučaju, najveći postotak varijance u podacima za izlaznu varijablu `wealth.worth in billions` objašnjava regresor `demographics.age`. Trenutan model objašnjava svega 7.7% varijance u podacima (Adjusted $R=0.07766$) za reakciju `wealth.worth in billions`. Na žalost, ovaj model ne objašnjava velik dio varijance u podacima.

Sad ćemo pokušati pronaći najbolje prediktore na sljedeći način: stvarati ćemo model lienarne regresije za svaki regresor pojedinačno, i očitavati ćemo koliko oni statistički značajno objašnjavaju varijancu u podacima (očitavamo p vrijednosti svakog modela nakon fittanja)


```{r}

n = 10
filtered_col_names = c()
r_squares = c()
ps = c()
col_names=colnames(x)

for(i in 1:ncol(x)){
  
  col_name=col_names[i]
  model=lm(wealth ~ x[[col_name]]) # napravi lienarni model s jednim regresorom
  summary_model = summary(model)
  
  filtered_col_names <- append(filtered_col_names, col_name)
  r_squares <- append(r_squares, summary_model$r.squared)
  ps <- append(ps,  summary_model$coefficients[,4][2])
}

df_g_squares=data.frame(filtered_col_names, r_squares, ps)
df_top_predictors = df_g_squares[order(df_g_squares$ps), ]
df_top_predictors[1:n, ]
top_n_predictors_one_var_lin <- df_top_predictors[1:n, "filtered_col_names"]
```

Možemo zaključiti da kad bi smo morali napraviti linearni model koji najbolje predviđa reaktor `wealth.worth in billions`, odabrali bi smo upravo regresor `wealth.how.inherited_not inherited`. Međutim ako želimo napraviti multivarijatni linearni model, nije nužno istina da će najbolji model biti onaj za koji uzmemo prvih n regresora iz trenutne liste. Problem koji se može pojaviti takvim pristupom odabira regresora je da postoje regresori koji su međusobno zavisni (iako smo već prethodno otklonii jako zavisne regresore).

Najbolje regresore također možemo pronaći ANOVA-om. Kada dodamo ili izbrišemo prediktivnu varijablu iz linearne regresije, želimo znati je li ta promjena poboljšala model ili nije. ANOVA uspoređuje dva regresijska modela i javlja jesu li značajno različiti. Spojiti ćemo najbolje regresore koje smo dobili ANOVOM i najbolje regresore dobivene u prethodnom koraku da stvorimo novi linearni model s manje regresora.

```{r}
a <- anova(model_all_vars)
ps_a <- a$`Pr(>F)`
ps_a <- head(ps_a, -1) # anova returns NA for last element

ps_a_ord <- order(ps_a)
sorted_cols <- colnames(x)[order(colnames(x))]
top_predictors_anova <- sorted_cols[ps_a_ord][1:n]

top_predictors = c(top_predictors_anova, top_n_predictors_one_var_lin)
top_predictors <- top_predictors[!duplicated(top_predictors)]

cat("Broj regersora", length(top_predictors))
model_top_preds <- lm(wealth ~ . , x[, top_predictors])
summary(model_top_preds)
```
Pokazali smo da smanjenjem broja regresora na 14 i dalje objašnjavamo usporedivo velik dio varijance (6.1%, originalo 7.7%). Ovisno o namjeni i potrebama možemo se opredijeliti za složeniji ili jednostavniji model. Jednostavniji model je preferiraniji ukoliko je realtivno dobar kao neki alternativni složeniji model.



Za kraj, provjeritit ćemo prepostavku linearnog modela (normalnost reziduala) grafički i korištenjem Kolmogorov-Smirnov i Lilliefors testa  .
```{r, collapse=TRUE}
require(nortest)
plot(model_top_preds$fitted.values, model_top_preds$residuals) 
hist(rstandard(model_top_preds))
qqnorm(rstandard(model_top_preds))
ks.test(rstandard(model_top_preds),'pnorm')
lillie.test(rstandard(model_top_preds))
```



## 4. Kada biste birali karijeru isključivo prema kriteriju da se obogatite, koju biste industriju izabrali?

Pretpostavljamo da karijerom u određenoj industriji, a ne nasljedstvom zarađujemo novac. Zbog toga gledamo samo milijardere koji nisu nasljedili svoje bogatstvo.
Također, zanimaju nas samo najnoviji milijarderi odnosno oni s popisa iz 2014. godine, jer su vremenski najrelevantniji. 
Uz taj skup milijardera, uzet ćemo i skup milijardera iz 2014. koji nisu bili na popisu 2001., odnosno novonastale milijardere. Na tom skupu vidjet će se u kojim industrijama je nastalo najviše milijardera.
Za kraj ćemo uzeti u razmatranje i skup milijardera koji su bili na popisu 2001. godine, ali zbog određenog razloga više nisu. Tu ćemo vidjeti koje su industrije u tom razdoblju izgubile najviše milijardera.

```{r, results='hide'}
non_inherited_2014 <- non_inherited[non_inherited$year == 2014,]
non_inherited_2001 <- non_inherited[non_inherited$year == 2001,]
non_inherited_2014_new = bill_data[FALSE,]
non_inherited_2001_old = bill_data[FALSE,]

# selekcija novonastalih milijardera iz 2014. koji nisu bili na prethodnoj listi iz 2001.
for(i in 1:nrow(non_inherited_2014)) {
  r <- non_inherited_2014[i,]
  if(sum(str_detect(non_inherited_2001$name, r[[1]])) == 0) {
    non_inherited_2014_new <- rbind(non_inherited_2014_new, non_inherited_2014[i,])
  }
}

# selekcija milijardera iz 2001. koji nisu na listi iz 2014.
for(i in 1:nrow(non_inherited_2001)) {
  r <- non_inherited_2001[i,]
  if(sum(str_detect(non_inherited_2014$name, r[[1]])) == 0) {
    non_inherited_2001_old <- rbind(non_inherited_2001_old, non_inherited_2001[i,])
  }
}
```

```{r}

par(mar=c(10,7,1,1))
barplot(sort(table(subset(non_inherited_2014$wealth.how.industry, non_inherited_2014$wealth.how.industry != "0")), decreasing = TRUE),
        main = "Distribucija milijardera po industrijama u 2014.",
        las = 2)
```
Iz stupčastog grafa je vidljivo da su tri najzastupljenije industrije maloprodaja (trgovački lanci, lanci restorana), trgovina nekretninama i računalna tehnologija.

```{r}
par(mar=c(10,5,1,1))
barplot(sort(table(subset(non_inherited_2014_new$wealth.how.industry, non_inherited_2014_new$wealth.how.industry != "0")), decreasing = TRUE),
        main = "Distribucija novonastalih milijardera po industrijama u 2014.",
        las = 2)
```
Ako usporedimo ovaj graf s prethodnim može se vidjeti da su vrlo slični, jedina razlika je u poretku medijske industrije. To nam govori da se broj milijardera po industrijama mijenja otprilike istom brzinom, odnosno da industrije s najviše milijardera dobivaju najveći broj novih milijardera (i obrnuto).

```{r}
par(mar=c(10,5,1,1))
barplot(sort(table(subset(non_inherited_2001_old$wealth.how.industry, non_inherited_2001_old$wealth.how.industry != "0")), decreasing = TRUE),
        main = "Distribucija bivših milijardera po industrijama iz 2001.",
        las = 2)
```
Na posljednjem grafu možemo potvrditi prethodno uočeno kretanje medijske industrije. Za razliku od ostalih industrija, broj milijardera u medijskoj industriji jedini je toliko značajno pao da je medijska industrija pala u ukupnom poretku. Sukladno tome na ovom grafu vidimo da je medijska industrija doživjela neproporcionalan pad broja milijardera. Međutim, medijska industrija nije među najvećim industrijama tako da ne utječe na zaključak, odnosno tri najzastupljenije industrije nisu se promjenile.

Zaključno, industrije koje se mogu predložiti na temelju ovih grafova su ponajprije maloprodaja, trgovanje nekretninama i računalna tehnologija. Te industrije najbolji su odabir za početak karijere s ciljem postajanja milijarderom ponajprije zbog najveće količine milijardera u tim industrijama (i sukladno tome najvećeg broja novonastalih milijardera).